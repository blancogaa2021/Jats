context("Meta Analysis")

options <- jasptools::analysisOptions("ClassicalMetaAnalysis")
options$covariates <- "contcor2"
options$dependent  <- "contNormal"
options$factors    <- c("facGender", "facExperim")
options$forestPlot <- TRUE
options$funnelPlot <- TRUE
options$funnelPlotAsymmetryTest <- TRUE
options$method     <- "Restricted ML"
options$modelTerms <- list(list(components = "contcor2"), 
                           list(components = "facGender"), 
                           list(components = "facExperim"))
options$plotResidualsCovariates <- TRUE
options$plotResidualsDependent  <- TRUE
options$plotResidualsPredicted  <- TRUE
options$rSquaredChange <- TRUE
options$regressionCoefficientsConfidenceIntervals <- TRUE
options$regressionCoefficientsCovarianceMatrix <- TRUE
options$residualsCasewiseDiagnostics <- TRUE
options$studyLabels  <- "contBinom"
options$trimFillPlot <- TRUE
options$wlsWeights   <- "debCollin1"
set.seed(1)
results <- jasptools::run("ClassicalMetaAnalysis", "debug.csv", options)

test_that("Influence Measures table results match", {
  table <- results[["results"]][["casewiseTable"]][["data"]]
  expect_equal_tables(table,
                      list(262.732350870067, 0.0400378184752686, 1.07230885151213, 0.199763610175038,
                           0.0551419254175412, 1, 0.826671964662481, 0.714326031980455,
                           1.02013544871556, 256.178327946014, 0.129653797670661, 0.992489685001572,
                           -0.363356145031213, 0.0532361232571621, 2, -1.53026301584699,
                           0.693044256062938, 1.17325184481961, 252.104071340083, 0.130107703282504,
                           0.955799988714369, 0.365882892108391, 0.0448001488250868, 3,
                           1.6848043442563, 0.684994293447751, 1.25741507559644, 259.540993791085,
                           0.0624768342258867, 1.00380567459012, 0.250944606537475, 0.0345435263374786,
                           4, 1.32453918608363, 0.70174247901759, 1.01909462525274, 263.230540141172,
                           0.0149092477680681, 1.06903418273161, -0.121661900735042, 0.0391217340610604,
                           5, -0.604582056053913, 0.718254191512592, 1.08744711789683,
                           256.90637912375, 0.0875666622802147, 0.983097211158387, -0.29825995693398,
                           0.0381522318730287, 6, -1.49460948337919, 0.69482469344226,
                           1.13683800695382, 264.391499077268, 0.00113847072121011, 1.06171002333134,
                           -0.0336055771280454, 0.0248380518467288, 7, -0.209296627571492,
                           0.720495080400654, 0.906538477607375, 263.185696184134, 0.0228321255250091,
                           1.07131544837111, -0.15070486684049, 0.0466571914708536, 8,
                           -0.681930278940677, 0.716607810291418, 1.00865294840775, 263.503982057869,
                           0.0150143574590837, 1.0633698594597, 0.122195250475624, 0.0374681406173809,
                           9, 0.62007207281698, 0.717218478915165, 0.957568702046681, 264.303646920765,
                           0.00491869083920503, 1.08903804851365, -0.0698406163632372,
                           0.0489589452046736, 10, -0.305633358500751, 0.720600532353734,
                           0.960061694175131, 263.130014054492, 0.0157520342175195, 1.04526955506304,
                           0.125265510956865, 0.0273714728953213, 11, 0.746833568420508,
                           0.715299483591345, 0.94081355402465, 263.923890851722, 0.00651024016783392,
                           1.07064000024066, 0.0803106715475908, 0.0329679112274638, 12,
                           0.434799690509734, 0.72050745705593, 1.07800888366839, 263.637416957089,
                           0.0213816529890195, 1.08568632737589, -0.145790569069402, 0.0556091729001072,
                           13, -0.599783062488506, 0.717713933250214, 0.9598516578749,
                           264.064019536477, 0.00469439998031477, 1.05768256863823, -0.0682815782236007,
                           0.0257115224456209, 14, -0.420585487425781, 0.719151799042604,
                           0.913755734694117, 252.112140337978, 0.166554937076436, 0.887092570380186,
                           -0.415553354189001, 0.0326029174346965, 15, -2.25734082389787,
                           0.668058676936457, 0.956162544177124, 262.019669281644, 0.0492079174138658,
                           1.08849500599352, -0.221367831739762, 0.0679451840487333, 16,
                           -0.82025156155775, 0.714717406822812, 1.16008969471307, 263.940584701539,
                           0.00984278052869491, 1.07818925856344, 0.0988032106876962, 0.0422108455857725,
                           17, 0.469565366081506, 0.719767462515528, 1.03066477221473,
                           262.635998813336, 0.0277884742151193, 1.0540039336839, 0.166447527593902,
                           0.0394506405195474, 18, 0.821753833431341, 0.714111619826483,
                           0.986166033035772, 259.7462165447, 0.06496753475501, 1.00973469328686,
                           -0.255798417913256, 0.0373051108291292, 19, -1.29793790855314,
                           0.702593803717153, 1.01716197271916, 261.892920274869, 0.0276194775159344,
                           1.03051207870342, 0.166153419014527, 0.0278737446530384, 20,
                           0.981180886648714, 0.711111089152778, 1.02456732152875, 263.410997302875,
                           0.0163818848063187, 1.04745366368733, -0.127806314244882, 0.0308685802106828,
                           21, -0.716622116361629, 0.71486267251089, 0.780659988310177,
                           264.486126634818, 9.42765967859866e-05, 1.09693876458671, -0.00966882346617827,
                           0.0566452486183803, 22, -0.0376060978734504, 0.720329555584944,
                           0.846581708463617, 264.467216113266, 0.000347663681632089, 1.12078961047271,
                           -0.0185528845994792, 0.0733174843774056, 23, -0.0662837042013889,
                           0.721393604591763, 0.949292948169384, 264.084401539423, 0.00582571672299131,
                           1.08177342889251, 0.0760064288879191, 0.0434992819082006, 24,
                           0.358511618579171, 0.720327554289507, 0.991719996768945, 249.807617980615,
                           0.296071798669854, 0.862570603808377, 0.556996539324681, 0.0471343702938604,
                           25, 2.51526893842518, 0.656354535075111, 0.965213760722877,
                           263.237229906306, 0.0129781716807687, 1.06427327517358, -0.113487732485723,
                           0.0340885708947719, 26, -0.605472911645839, 0.718471396576595,
                           1.11383590369921, 264.477139925839, 0.00024136383287593, 1.10271858944973,
                           0.0154535436569728, 0.0579092285640316, 27, 0.0620624629963332,
                           0.721464770583211, 0.955843246357338, 261.592349033842, 0.0383826843075627,
                           1.03821523152685, -0.195911090440106, 0.0366654104761845, 28,
                           -1.00419180922472, 0.710646361209932, 1.08126598605143, 262.031531803146,
                           0.0523221803493081, 1.05658703904295, 0.228688920569409, 0.0518091933978843,
                           29, 0.978321396192137, 0.711127420763697, 0.986008111237554,
                           264.334192024572, 0.00170018192868321, 1.06932394906259, 0.0410260087217103,
                           0.0279703377923599, 30, 0.240971183816203, 0.721627084235482,
                           1.02915920952368, 260.090898997263, 0.0586951920070979, 1.00372351040421,
                           -0.243094816746173, 0.0323351912136825, 31, -1.32847951049045,
                           0.702367557275806, 0.941311872170127, 264.473062127682, 3.45601878789036e-05,
                           1.08736723880078, 0.00582826919393597, 0.0395764013571677, 32,
                           0.0315044745520896, 0.722990864379933, 1.09520218639425, 260.156280370592,
                           0.0443225530934775, 1.01040059762166, 0.211078164318548, 0.0296249670629047,
                           33, 1.20721091819925, 0.705019002426001, 1.06577540862248, 262.084543331013,
                           0.03095444230226, 1.03770604219735, 0.175870502580463, 0.0332205524089201,
                           34, 0.948941127884395, 0.711519999060467, 0.970747228146241,
                           264.462181817776, 0.000306366892144507, 1.07252279981121, -0.0174049333562668,
                           0.0297863138786156, 35, -0.0986702777455403, 0.721946566469843,
                           1.00752893980872, 263.199487748789, 0.0178212903684756, 1.06770348297196,
                           0.133045213981202, 0.0397098808383198, 36, 0.653655734739846,
                           0.71772220224666, 1.09207612142027, 264.414307389591, 0.000710358994776927,
                           1.0677671844022, 0.0265230345696218, 0.0271103785012906, 37,
                           0.160102482611091, 0.721460471519471, 0.981144883255629, 259.790203136184,
                           0.0725276301870286, 1.00590558899725, 0.27039774270445, 0.0379613916590061,
                           38, 1.3627774206512, 0.701335856457346, 0.993106748469139, 264.202563630793,
                           0.00353560503720372, 1.0671530651487, -0.0592518854324629, 0.0326923949591393,
                           39, -0.324217342937164, 0.71964212751066, 0.892076466536199,
                           263.301053090431, 0.0117573333163136, 1.05482541084631, -0.108085055313971,
                           0.0283239550278417, 40, -0.633912819941443, 0.717618997656188,
                           1.04555961161393, 264.282863064434, 0.00251203339343546, 1.06980942367922,
                           -0.0498848915151949, 0.0299101371547695, 41, -0.282739864658242,
                           0.721184457990021, 1.01000844076643, 259.231442911687, 0.0800389943663724,
                           0.996362396565014, -0.284340700289489, 0.0373293369426948, 42,
                           -1.4444383827718, 0.698843144833853, 0.977072351937748, 264.211959185435,
                           0.00357796893460873, 1.07904630904712, -0.0595076833909259,
                           0.0368126541473998, 43, -0.304298802618047, 0.721607860439429,
                           1.07014601249758, 262.987216670837, 0.0303266901175038, 1.07177258641339,
                           -0.173788796983329, 0.0511268003882449, 44, -0.749147803482661,
                           0.715388201289679, 0.983653989095089, 263.91501713302, 0.00664985056785538,
                           1.05194732030687, -0.0813134513981273, 0.0242324715305451, 45,
                           -0.51470019483984, 0.718031767923289, 0.881779902966192, 258.216307742723,
                           0.0850030233094572, 1.00033295743934, 0.293231631247393, 0.0419618315044775,
                           46, 1.39710830452012, 0.698590578221128, 1.08883920788334, 264.446586118049,
                           0.000620656638867983, 1.09545268540313, -0.024756463092253,
                           0.0468874546121777, 47, -0.111726660749746, 0.722927124078898,
                           1.10284462812178, 264.018041777372, 0.00576819964447554, 1.06477300042041,
                           0.0756412387925049, 0.0297146665445655, 48, 0.430969687240779,
                           0.719889438740922, 0.999570587218623, 249.000285930228, 0.181559824467493,
                           0.843572355106713, -0.436758829752031, 0.0298260274797383, 49,
                           -2.49536437982044, 0.65517932573377, 0.997824926430928, 264.480335012354,
                           0.00010393646520462, 1.08854696180227, 0.0101171093065663, 0.0422944749736182,
                           50, 0.0481546700990743, 0.722482445252907, 1.04905179991346,
                           264.408346779589, 0.00095113547999911, 1.05934358954801, -0.0307260165206774,
                           0.023998454197374, 51, -0.194848700543862, 0.720100769284271,
                           0.864343492689289, 258.368515845456, 0.0691111885522946, 0.970133273970689,
                           -0.264665895994433, 0.0268100449674393, 52, -1.59510609803463,
                           0.694417443179183, 0.94731200407551, 263.000840449961, 0.0311582839178545,
                           1.07241011399101, 0.17610957358682, 0.0506342844037787, 53,
                           0.761665531377413, 0.715710235284731, 1.03915875016335, 264.485607271366,
                           0.000137321650901439, 1.09880850775722, -0.0116419221733311,
                           0.0494264825407868, 54, -0.0485535247105303, 0.723040168732542,
                           1.10048112594451, 244.993636623832, 0.435718059993702, 0.793631102358943,
                           0.681250964577909, 0.0487189327131783, "55*", 3.03868188160114,
                           0.63373502700228, 0.912003267964907, 264.397562424106, 0.00176404366457001,
                           1.06896398992258, -0.0418402122071319, 0.0319725289485183, 56,
                           -0.227584134309606, 0.720339431614264, 0.895359586946968, 263.682169614338,
                           0.0166991829795047, 1.08327845987416, 0.128810513059293, 0.0519053135497598,
                           57, 0.551303096189933, 0.718199004143768, 0.971586474203684,
                           264.471276026243, 0.000299985603565444, 1.06995157967555, 0.0172455956482909,
                           0.0318437760394785, 58, 0.093565019403167, 0.720639681017737,
                           0.885500312230464, 264.333344669015, 0.00176718059686404, 1.05551047547065,
                           0.0419102806677818, 0.0238178047538881, 59, 0.269151514569511,
                           0.719114746158142, 0.80504829426005, 264.365978722454, 0.00148774047042485,
                           1.0635056169653, 0.0384106859130227, 0.0259347060824912, 60,
                           0.233976946388302, 0.720656931083091, 0.931843387372788, 262.950252307175,
                           0.0232934473810008, 1.04413964512889, 0.15242756233451, 0.0314725911045964,
                           61, 0.844636046239098, 0.713788423943177, 0.917615352513552,
                           262.786058067816, 0.0255309324155376, 1.0452986996255, -0.159585299884791,
                           0.0332126721762813, 62, -0.860280337238193, 0.713593174038668,
                           0.954703676749585, 260.848882894022, 0.0747437681320256, 1.03143034511094,
                           -0.273986123720313, 0.0478484920151539, 63, -1.22308868517711,
                           0.705487505287832, 0.968284159650685, 249.37224560888, 0.163009895357696,
                           0.872694564502329, 0.413323792806684, 0.0333305228438864, 64,
                           2.22332792760769, 0.663345642805233, 1.11138539645608, 264.263285345332,
                           0.00408183844281448, 1.07300861486857, 0.0636241017047151, 0.0352159607893979,
                           65, 0.330621622453422, 0.720465569605701, 0.966467342682284,
                           263.547388650994, 0.0162131427195097, 1.06577311255296, -0.126958713925477,
                           0.0389157120710873, 66, -0.629820389652029, 0.717434383359289,
                           0.983361653113583, 257.861519568661, 0.100070328526071, 0.964539426610873,
                           0.318899372081109, 0.0334000114773794, 67, 1.72260605012161,
                           0.690910625674687, 0.93054970941149, 262.885206032293, 0.0226378429791355,
                           1.0755650462777, 0.14996441923553, 0.0478939862307731, 68, 0.669841756057418,
                           0.717376530507227, 1.11597018939174, 263.9311181682, 0.0118276744209341,
                           1.12528708660025, -0.108095096375888, 0.0746214113506653, 69,
                           -0.380284802618594, 0.72219617008024, 1.20750228957917, 263.633670771905,
                           0.00913876368490833, 1.07363859297916, 0.095124810800919, 0.0358987703577931,
                           70, 0.493211057261931, 0.720446513508, 1.15384630290158, 264.152766390337,
                           0.00528576923429818, 1.07458459499069, -0.0724096968247506,
                           0.0376987141569674, 71, -0.365625887153166, 0.720147675639769,
                           0.968324830851101, 262.922668106312, 0.0169256038657697, 1.04418733369507,
                           -0.129855235628153, 0.0274244241123892, 72, -0.773723038635124,
                           0.714989687748589, 0.978363651951187, 264.155309044222, 0.00309215698110061,
                           1.07354643115722, 0.0553000972711742, 0.0307631485502674, 73,
                           0.31167808646752, 0.721940656629064, 1.11214391584654, 262.277720755017,
                           0.0234757454901421, 1.03261283467631, -0.153121187898895, 0.0264947988940786,
                           74, -0.928234642676591, 0.712091456209771, 0.973600996531128,
                           253.179693939302, 0.206116599950869, 0.972205811747802, -0.460423506077168,
                           0.0650966047580989, 75, -1.73691425077676, 0.683755107393275,
                           1.18247846263982, 264.250555889891, 0.00285924531675709, 1.05872482226843,
                           0.0532835859361657, 0.0250483234782883, 76, 0.331467049198659,
                           0.71962635396489, 0.887331840316315, 264.287096049129, 0.00315253252146909,
                           1.06675661988464, -0.0559446519575265, 0.0316431285565131, 77,
                           -0.307863825910765, 0.719845627039266, 0.891081194595183, 264.203813246495,
                           0.00441388307908337, 1.06773329986483, 0.0662006172671524, 0.0333447104550212,
                           78, 0.356027469629469, 0.719604325652675, 0.902876328166279,
                           259.283889896958, 0.070117553442553, 1.00549028144472, -0.265928515613536,
                           0.0379914266301231, 79, -1.33560926775154, 0.70120531529104,
                           1.03491409134237, 264.450442631079, 0.000677088098861299, 1.08508617547386,
                           0.02589677300605, 0.0428901154205797, 80, 0.122363582611671,
                           0.721380593474931, 0.960432884352045, 262.284905947309, 0.0298763914266524,
                           1.04418036083254, -0.172704130056015, 0.0357084345169947, 81,
                           -0.897894843186011, 0.712554793380592, 0.977865356709139, 263.326580913546,
                           0.0459927390561055, 1.13941072614198, 0.213742141023718, 0.0999217667730841,
                           82, 0.64111746871274, 0.717797896650162, 1.06964746833055, 227.862349461133,
                           0.40010099352783, 0.627364704748626, 0.677764368512727, 0.032970833075749,
                           "83*", 3.59886579622404, 0.577355414942708, 1.11025096934081,
                           264.422983828242, 0.000606774934210719, 1.06532003298717, -0.0245176416445022,
                           0.0257088358727732, 84, -0.151899096254993, 0.721212844094056,
                           0.954896418186984, 264.210650343259, 0.00318800194189171, 1.06227140287373,
                           -0.0562364321411354, 0.0264013638569607, 85, -0.34051150352262,
                           0.720189866667162, 0.951323929225293, 264.146063808404, 0.00792457287408484,
                           1.0852416102957, 0.0887461379005808, 0.0512159741611121, 86,
                           0.382063155630509, 0.718909377739538, 0.848936406110151, 264.429714720284,
                           0.00115798749927805, 1.0736205527411, 0.0338743573213558, 0.0330364556565167,
                           87, 0.180835325886534, 0.721274933243793, 0.966456809635037,
                           264.347049522363, 0.00148782840131327, 1.08788080390753, -0.0383354650110583,
                           0.0403447687234004, 88, -0.188712314819792, 0.722899509307816,
                           1.12945313877843, 262.239015324698, 0.0405667829919694, 1.05896686332706,
                           -0.201218634823186, 0.0483763262407339, 89, -0.892662879169897,
                           0.71279328759091, 1.0057858458384, 264.339042830507, 0.00249547211662034,
                           1.07669071647814, -0.0497100437361629, 0.0349748727487329, 90,
                           -0.258917851997594, 0.721522866081739, 1.02632841888735, 258.98128252755,
                           0.114434455174354, 1.0305961710837, -0.339824991804473, 0.0613682115506481,
                           91, -1.32898304047584, 0.70121109120504, 1.10538894706546, 264.289548545314,
                           0.00299269543653001, 1.09195122599515, -0.0543447470555744,
                           0.0426950629004374, 92, -0.255182034524808, 0.723280164168046,
                           1.1976778549948, 263.942262202072, 0.0259131692586968, 1.13258498678982,
                           0.160490129135178, 0.0925399977507914, 93, 0.501882152795277,
                           0.718380871772597, 0.891464958254635, 264.483134323259, 0.000223067552319244,
                           1.07748641736248, -0.014882056274052, 0.0407250818906758, 94,
                           -0.0699815779908251, 0.720003379348952, 0.821984466864253, 264.477358812021,
                           0.000102824886037141, 1.06658971138016, 0.0100839170365109,
                           0.0284390778273268, 95, 0.059315383267866, 0.720746474038474,
                           0.892556075718011, 264.221965135642, 0.00399736923362325, 1.07389749687345,
                           0.0629454006230085, 0.0350651227776714, 96, 0.328782282406387,
                           0.72074827307326, 0.996678038437571, 264.461935329477, 0.000519052043396646,
                           1.10766878855957, 0.0226463298088812, 0.0584995019584291, 97,
                           0.0907130585447701, 0.722588438082422, 1.06664745485891, 264.485958211608,
                           1.18149369745151e-05, 1.06470799045691, -0.00340463293606924,
                           0.0285334915283407, 98, -0.0174794156711009, 0.720209798234173,
                           0.840484566567, 260.887242493081, 0.0458911671569589, 1.03696075095317,
                           -0.214367307801245, 0.0404687705383334, 99, -1.04339288337071,
                           0.70918053539942, 1.08865793243946, 262.431804838242, 0.0283445172487908,
                           1.04522443621758, 0.168194264235212, 0.0354266658559477, 100,
                           0.878119135080372, 0.712921459645946, 0.964495696169567))
})

test_that("Coefficients table results match", {
  table <- results[["results"]][["coeffTable"]][["data"]]
  expect_equal_tables(table,
                      list(-0.442978799963177, -0.796105934144409, "intrcpt", 0.0139453388413607,
                           0.180170215078078, -0.0898516657819454, -2.4586683196843, 0.0627001759624519,
                           -0.150376029750759, "contcor2", 0.564113469510082, 0.108714347030799,
                           0.275776381675662, 0.576742423377559, 0.488477502169315, 0.0606088917506714,
                           "facGenderm", 0.0252472258519366, 0.218304321878368, 0.916346112587959,
                           2.23759886183782, 0.011079948618749, -0.417996968163601, "facExperimexperimental",
                           0.95963496153271, 0.218920816042528, 0.440156865401099, 0.0506116723801931
                      ))
})

test_that("Parameter Covariances table results match", {
  table <- results[["results"]][["covMatTable"]][["data"]]
  expect_equal_tables(table,
                      list(-0.00359216662392862, -0.0207831006432576, -0.0204871467233023,
                           0.0324613064012809, "intrcpt", 0.011818809250333, 0.00308945286134289,
                           0.00252843577029779, -0.00359216662392862, "contcor2", 0.00252843577029779,
                           -0.00715927260823057, 0.0476567769507742, -0.0204871467233023,
                           "facGenderm", 0.00308945286134289, 0.0479263236967265, -0.00715927260823057,
                           -0.0207831006432576, "facExperimexperimental"))
})

test_that("File Drawer Analysis table results match", {
  table <- results[["results"]][["failSafeTable"]][["data"]]
  expect_equal_tables(table,
                      list(0.05, 208, "Rosenthal", 0.00196593842759479))
})

test_that("Fixed and Random Effects table results match", {
  table <- results[["results"]][["fixRandTable"]][["data"]]
  expect_equal_tables(table,
                      list(3, "Omnibus test of Model Coefficients", 0.154998519713527, 5.24067551299979,
                           96, "Test of Residual Heterogeneity", 1.11540464463198e-17,
                           264.486146695969))
})

test_that("Diagnostic Plots matches", {
  plotName <- results[["results"]][["plots"]][["collection"]][["plots_diagnosticPlot"]][["data"]]
  testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
  expect_equal_plots(testPlot, "diagnostic-plots", dir="ClassicalMetaAnalysis")
})

test_that("Forest plot matches", {
  plotName <- results[["results"]][["plots"]][["collection"]][["plots_forest"]][["data"]]
  testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
  expect_equal_plots(testPlot, "forest-plot", dir="ClassicalMetaAnalysis")
})

test_that("Funnel Plot matches", {
  plotName <- results[["results"]][["plots"]][["collection"]][["plots_funnel"]][["data"]]
  testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
  expect_equal_plots(testPlot, "funnel-plot", dir="ClassicalMetaAnalysis")
})

test_that("Profile plot matches", {
  plotName <- results[["results"]][["plots"]][["collection"]][["plots_profile"]][["data"]]
  testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
  expect_equal_plots(testPlot, "profile", dir="ClassicalMetaAnalysis")
})

test_that("Trim-fill Analysis plot matches", {
  plotName <- results[["results"]][["plots"]][["collection"]][["plots_trimFill"]][["data"]]
  testPlot <- results[["state"]][["figures"]][[plotName]][["obj"]]
  expect_equal_plots(testPlot, "trim-fill-analysis", dir="ClassicalMetaAnalysis")
})

test_that("Rank correlation test for Funnel plot asymmetry table results match", {
  table <- results[["results"]][["rankTestTable"]][["data"]]
  expect_equal_tables(table,
                      list(0.00686868686868687, "Rank test", 0.921921630071705))
})

test_that("Regression test for Funnel plot asymmetry (\"Egger's test\") table results match", {
	table <- results[["results"]][["regTestTable"]][["data"]]
	expect_equal_tables(table,
		list("contcor2", 0.566307601801007, 0.5734979277382))
})

test_that("Residual Heterogeneity Estimates table results match", {
	table <- results[["results"]][["residualTable"]][["data"]]
	expect_equal_tables(table,
		list(0.71060416156282, 0.429926531732936, "<unicode><unicode><unicode><unicode>",
			 1.0688514723806, 0.842973405015141, 0.655687831008733, "<unicode><unicode>",
			 1.03385273244336, 62.9258791193162, 50.663389411549, "I<unicode><unicode> (%)",
			 71.8546415573073, 2.69729929191932, 2.02689237884956, "H<unicode><unicode>",
			 3.55298370790381))
})

test_that("Analysis handles errors", {
  options <- jasptools::analysisOptions("ClassicalMetaAnalysis")
  
  options$dependent  <- "debInf"
  options$wlsWeights <- "contGamma"
  results <- jasptools::run("ClassicalMetaAnalysis", "test.csv", options)
  expect_identical(results[["status"]], "validationError", label="Inf dependent check")
  
  options$dependent <- "contNormal"
  options$wlsWeights <- "debInf"
  results <- jasptools::run("ClassicalMetaAnalysis", "test.csv", options)
  expect_identical(results[["status"]], "validationError", label="Inf covariate check")
  
  options$dependent <- "debSame"
  options$wlsWeights <- "contGamma"
  results <- jasptools::run("ClassicalMetaAnalysis", "test.csv", options)
  expect_identical(results[["status"]], "validationError", label="No variance dependent check")
  
  options$dependent <- "contNormal"
  options$wlsWeights <- "debSame"
  results <- jasptools::run("ClassicalMetaAnalysis", "test.csv", options)
  expect_identical(results[["status"]], "validationError", label="No variance covariate check")
  
  options$dependent <- "contGamma"
  options$wlsWeights <- "contcor1"
  results <- jasptools::run("RegressionLinear", "test.csv", options)
  expect_identical(results[["status"]], "validationError", label="Negative wlsWeights check")
  
})


#options <- jasptools::analysisOptions("ClassicalMetaAnalysis")
#options$dependent  <- "contNormal"
#options$covariates <- c("contcor1", "contcor2")
#options$factors <- "debBinMiss20"
#options$studyLabels <- "facExperim"
#options$wlsWeights <- "contGamma"
#options$modelTerms <- list(list(components = "contcor1"), list(components = "contcor2"), list(components = "debBinMiss20"))
#results <- jasptools::run("ClassicalMetaAnalysis", "debug.csv", options)
